<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileCachePlaybackStrategy.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">infra-cache</a> &gt; <a href="index.source.html" class="el_package">dev.cafe.cache</a> &gt; <span class="el_source">FileCachePlaybackStrategy.java</span></div><h1>FileCachePlaybackStrategy.java</h1><pre class="source lang-java linenums">package dev.cafe.cache;

import dev.cafe.audio.AudioTrack;
import dev.cafe.audio.PlaybackStrategy;
import dev.cafe.cache.dagger.Streaming;
import java.io.File;
import java.sql.SQLException;
import javax.inject.Inject;
import javax.inject.Singleton;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/** A playback strategy that attempts to play from a local cache first. */
@Singleton
public class FileCachePlaybackStrategy implements PlaybackStrategy {
<span class="nc" id="L16">  private static final Logger logger = LoggerFactory.getLogger(FileCachePlaybackStrategy.class);</span>

  private final PlaybackStrategy streamingStrategy;
  private final MostPlayedService mostPlayedService;
  private final TrackCacheService trackCacheService;

  @Inject
  public FileCachePlaybackStrategy(
      @Streaming PlaybackStrategy streamingStrategy,
      MostPlayedService mostPlayedService,
<span class="nc" id="L26">      TrackCacheService trackCacheService) {</span>
<span class="nc" id="L27">    this.streamingStrategy = streamingStrategy;</span>
<span class="nc" id="L28">    this.mostPlayedService = mostPlayedService;</span>
<span class="nc" id="L29">    this.trackCacheService = trackCacheService;</span>
<span class="nc" id="L30">  }</span>

  @Override
  public void startPlayback(long guildId, AudioTrack track) {
    try {
<span class="nc bnc" id="L35" title="All 2 branches missed.">      if (mostPlayedService.isCached(track.getVideoId())) {</span>
<span class="nc" id="L36">        File cachedFile = trackCacheService.getCacheFile(track.getVideoId());</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">        if (cachedFile.exists()) {</span>
<span class="nc" id="L38">          logger.info(&quot;Playing from cache: {}&quot;, track.getVideoId());</span>
          // We would need to update the PlaybackStrategy to be able to play a local file.
          // For now, we'll just log and fall back to streaming.
<span class="nc" id="L41">          streamingStrategy.startPlayback(guildId, track);</span>
        } else {
<span class="nc" id="L43">          logger.warn(</span>
              &quot;Track {} was marked as cached, but file not found. Streaming instead.&quot;,
<span class="nc" id="L45">              track.getVideoId());</span>
<span class="nc" id="L46">          mostPlayedService.setCached(track.getVideoId(), false);</span>
<span class="nc" id="L47">          streamingStrategy.startPlayback(guildId, track);</span>
        }
<span class="nc" id="L49">      } else {</span>
<span class="nc" id="L50">        streamingStrategy.startPlayback(guildId, track);</span>
      }
<span class="nc" id="L52">    } catch (SQLException e) {</span>
<span class="nc" id="L53">      logger.error(&quot;Failed to check cache status for track {}&quot;, track.getVideoId(), e);</span>
<span class="nc" id="L54">      streamingStrategy.startPlayback(guildId, track);</span>
<span class="nc" id="L55">    }</span>
<span class="nc" id="L56">  }</span>

  @Override
  public void stopPlayback(long guildId) {
<span class="nc" id="L60">    streamingStrategy.stopPlayback(guildId);</span>
<span class="nc" id="L61">  }</span>

  @Override
  public void pausePlayback(long guildId) {
<span class="nc" id="L65">    streamingStrategy.pausePlayback(guildId);</span>
<span class="nc" id="L66">  }</span>

  @Override
  public void resumePlayback(long guildId) {
<span class="nc" id="L70">    streamingStrategy.resumePlayback(guildId);</span>
<span class="nc" id="L71">  }</span>

  @Override
  public void setVolume(long guildId, int volume) {
<span class="nc" id="L75">    streamingStrategy.setVolume(guildId, volume);</span>
<span class="nc" id="L76">  }</span>

  @Override
  public boolean isPlaying(long guildId) {
<span class="nc" id="L80">    return streamingStrategy.isPlaying(guildId);</span>
  }

  @Override
  public boolean isPaused(long guildId) {
<span class="nc" id="L85">    return streamingStrategy.isPaused(guildId);</span>
  }

  @Override
  public AudioTrack getCurrentTrack(long guildId) {
<span class="nc" id="L90">    return streamingStrategy.getCurrentTrack(guildId);</span>
  }

  @Override
  public long getPosition(long guildId) {
<span class="nc" id="L95">    return streamingStrategy.getPosition(guildId);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>