<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SetupCommands.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bot-app</a> &gt; <a href="index.source.html" class="el_package">dev.cafe.bot</a> &gt; <span class="el_source">SetupCommands.java</span></div><h1>SetupCommands.java</h1><pre class="source lang-java linenums">package dev.cafe.bot;

import dev.cafe.cache.guild.GuildSettings;
import dev.cafe.cache.guild.GuildSettingsRepository;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.inject.Inject;
import javax.inject.Singleton;
import net.dv8tion.jda.api.Permission;
import net.dv8tion.jda.api.entities.channel.ChannelType;
import net.dv8tion.jda.api.entities.channel.concrete.TextChannel;
import net.dv8tion.jda.api.events.interaction.command.SlashCommandInteractionEvent;
import net.dv8tion.jda.api.events.message.MessageReceivedEvent;
import net.dv8tion.jda.api.events.session.ReadyEvent;
import net.dv8tion.jda.api.hooks.ListenerAdapter;
import net.dv8tion.jda.api.interactions.commands.DefaultMemberPermissions;
import net.dv8tion.jda.api.interactions.commands.build.Commands;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/** Handles the /setup command for guild-specific configuration. */
@Singleton
public class SetupCommands extends ListenerAdapter {

<span class="nc" id="L29">  private static final Logger LOGGER = LoggerFactory.getLogger(SetupCommands.class);</span>
<span class="nc" id="L30">  private static final Pattern CHANNEL_MENTION_PATTERN = Pattern.compile(&quot;&lt;#(\\d+)&gt;&quot;);</span>

  private final GuildSettingsRepository guildSettingsRepository;
<span class="nc" id="L33">  private final ConcurrentHashMap&lt;Long, Long&gt; pendingSetups =</span>
      new ConcurrentHashMap&lt;&gt;(); // userId -&gt; guildId
<span class="nc" id="L35">  private final ScheduledExecutorService timeoutExecutor =</span>
<span class="nc" id="L36">      Executors.newSingleThreadScheduledExecutor();</span>

  @Inject
<span class="nc" id="L39">  public SetupCommands(GuildSettingsRepository guildSettingsRepository) {</span>
<span class="nc" id="L40">    this.guildSettingsRepository = guildSettingsRepository;</span>
<span class="nc" id="L41">  }</span>

  @Override
  public void onReady(ReadyEvent event) {
<span class="nc" id="L45">    event</span>
<span class="nc" id="L46">        .getJDA()</span>
<span class="nc" id="L47">        .updateCommands()</span>
<span class="nc" id="L48">        .addCommands(</span>
<span class="nc" id="L49">            Commands.slash(&quot;setup&quot;, &quot;Set up the bot for this server.&quot;)</span>
<span class="nc" id="L50">                .setDefaultPermissions(</span>
<span class="nc" id="L51">                    DefaultMemberPermissions.enabledFor(Permission.ADMINISTRATOR))</span>
<span class="nc" id="L52">                .setGuildOnly(true))</span>
<span class="nc" id="L53">        .queue();</span>
<span class="nc" id="L54">  }</span>

  @Override
  public void onSlashCommandInteraction(SlashCommandInteractionEvent event) {
<span class="nc bnc" id="L58" title="All 2 branches missed.">    if (!event.getName().equals(&quot;setup&quot;)) {</span>
<span class="nc" id="L59">      return;</span>
    }

<span class="nc bnc" id="L62" title="All 2 branches missed.">    if (event.getGuild() == null) {</span>
<span class="nc" id="L63">      event.reply(&quot;This command can only be used in a server.&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L64">      return;</span>
    }

<span class="nc" id="L67">    event.deferReply(true).queue();</span>

<span class="nc" id="L69">    long userId = event.getUser().getIdLong();</span>
<span class="nc" id="L70">    long guildId = event.getGuild().getIdLong();</span>

<span class="nc" id="L72">    event</span>
<span class="nc" id="L73">        .getUser()</span>
<span class="nc" id="L74">        .openPrivateChannel()</span>
<span class="nc" id="L75">        .queue(</span>
            privateChannel -&gt; {
<span class="nc" id="L77">              privateChannel</span>
<span class="nc" id="L78">                  .sendMessage(</span>
                      &quot;Please link a text channel for me to post the queue and now-playing messages in. Just mention the channel, like #music.&quot;)
<span class="nc" id="L80">                  .queue(</span>
                      success -&gt; {
<span class="nc" id="L82">                        pendingSetups.put(userId, guildId);</span>
<span class="nc" id="L83">                        timeoutExecutor.schedule(</span>
                            () -&gt; {
<span class="nc bnc" id="L85" title="All 2 branches missed.">                              if (pendingSetups.remove(userId, guildId)) {</span>
<span class="nc" id="L86">                                privateChannel</span>
<span class="nc" id="L87">                                    .sendMessage(&quot;Your setup session has timed out.&quot;)</span>
<span class="nc" id="L88">                                    .queue();</span>
                              }
<span class="nc" id="L90">                            },</span>
                            2,
                            TimeUnit.MINUTES);
<span class="nc" id="L93">                        event.getHook().editOriginal(&quot;Check your DMs to continue setup.&quot;).queue();</span>
<span class="nc" id="L94">                      },</span>
                      failure -&gt; {
<span class="nc" id="L96">                        LOGGER.warn(&quot;Could not send DM to user {}&quot;, userId, failure);</span>
<span class="nc" id="L97">                        event</span>
<span class="nc" id="L98">                            .getHook()</span>
<span class="nc" id="L99">                            .editOriginal(</span>
                                &quot;I couldn't send you a DM. Please check your privacy settings.&quot;)
<span class="nc" id="L101">                            .queue();</span>
<span class="nc" id="L102">                      });</span>
<span class="nc" id="L103">            },</span>
            failure -&gt; {
<span class="nc" id="L105">              LOGGER.warn(&quot;Could not open DM with user {}&quot;, userId, failure);</span>
<span class="nc" id="L106">              event</span>
<span class="nc" id="L107">                  .getHook()</span>
<span class="nc" id="L108">                  .editOriginal(</span>
                      &quot;I couldn't open a DM with you. Please check your privacy settings.&quot;)
<span class="nc" id="L110">                  .queue();</span>
<span class="nc" id="L111">            });</span>
<span class="nc" id="L112">  }</span>

  @Override
  public void onMessageReceived(MessageReceivedEvent event) {
<span class="nc bnc" id="L116" title="All 4 branches missed.">    if (!event.isFromType(ChannelType.PRIVATE) || event.getAuthor().isBot()) {</span>
<span class="nc" id="L117">      return;</span>
    }

<span class="nc" id="L120">    long userId = event.getAuthor().getIdLong();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">    if (pendingSetups.containsKey(userId)) {</span>
<span class="nc" id="L122">      long guildId = pendingSetups.get(userId);</span>
<span class="nc" id="L123">      Matcher matcher = CHANNEL_MENTION_PATTERN.matcher(event.getMessage().getContentRaw());</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">      if (matcher.find()) {</span>
<span class="nc" id="L126">        String channelIdStr = matcher.group(1);</span>
<span class="nc" id="L127">        long channelId = Long.parseLong(channelIdStr);</span>
<span class="nc" id="L128">        var guild = event.getJDA().getGuildById(guildId);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (guild == null) {</span>
<span class="nc" id="L130">          event</span>
<span class="nc" id="L131">              .getChannel()</span>
<span class="nc" id="L132">              .sendMessage(&quot;Something went wrong, I can't find the server anymore.&quot;)</span>
<span class="nc" id="L133">              .queue();</span>
<span class="nc" id="L134">          pendingSetups.remove(userId);</span>
<span class="nc" id="L135">          return;</span>
        }

<span class="nc" id="L138">        TextChannel channel = guild.getTextChannelById(channelId);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (channel == null) {</span>
<span class="nc" id="L140">          event</span>
<span class="nc" id="L141">              .getChannel()</span>
<span class="nc" id="L142">              .sendMessage(</span>
                  &quot;That channel doesn't seem to exist in the server. Please mention a valid text channel.&quot;)
<span class="nc" id="L144">              .queue();</span>
<span class="nc" id="L145">          return;</span>
        }

<span class="nc" id="L148">        var selfMember = guild.getSelfMember();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (!selfMember.hasPermission(</span>
            channel, Permission.MESSAGE_SEND, Permission.MESSAGE_MANAGE)) {
<span class="nc" id="L151">          event</span>
<span class="nc" id="L152">              .getChannel()</span>
<span class="nc" id="L153">              .sendMessage(</span>
                  &quot;I don't have the required permissions (`Send Messages`, `Manage Messages`) in that channel. Please grant them and try again.&quot;)
<span class="nc" id="L155">              .queue();</span>
<span class="nc" id="L156">          return;</span>
        }

<span class="nc" id="L159">        channel</span>
<span class="nc" id="L160">            .sendMessage(&quot;🎶 **Queue** (auto-updated)&quot;)</span>
<span class="nc" id="L161">            .queue(</span>
                queueMsg -&gt; {
<span class="nc" id="L163">                  channel</span>
<span class="nc" id="L164">                      .sendMessage(&quot;▶️ **Now playing…**&quot;)</span>
<span class="nc" id="L165">                      .queue(</span>
                          nowPlayingMsg -&gt; {
<span class="nc" id="L167">                            queueMsg.pin().queue();</span>
<span class="nc" id="L168">                            nowPlayingMsg.pin().queue();</span>

<span class="nc" id="L170">                            GuildSettings settings =</span>
                                new GuildSettings(
                                    guildId,
                                    channelId,
<span class="nc" id="L174">                                    queueMsg.getIdLong(),</span>
<span class="nc" id="L175">                                    nowPlayingMsg.getIdLong());</span>
<span class="nc" id="L176">                            guildSettingsRepository.save(settings);</span>

<span class="nc" id="L178">                            event</span>
<span class="nc" id="L179">                                .getChannel()</span>
<span class="nc" id="L180">                                .sendMessage(</span>
                                    &quot;Great! I've linked to &quot;
<span class="nc" id="L182">                                        + channel.getAsMention()</span>
                                        + &quot;. I've created and pinned the queue and now-playing messages there.&quot;)
<span class="nc" id="L184">                                .queue();</span>
<span class="nc" id="L185">                            pendingSetups.remove(userId);</span>
<span class="nc" id="L186">                          });</span>
<span class="nc" id="L187">                });</span>

<span class="nc" id="L189">      } else {</span>
<span class="nc" id="L190">        event</span>
<span class="nc" id="L191">            .getChannel()</span>
<span class="nc" id="L192">            .sendMessage(</span>
                &quot;That doesn't look like a channel mention. Please mention a text channel from the server, for example: #music.&quot;)
<span class="nc" id="L194">            .queue();</span>
      }
    }
<span class="nc" id="L197">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>