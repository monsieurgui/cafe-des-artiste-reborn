<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AudioCommands.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bot-app</a> &gt; <a href="index.source.html" class="el_package">dev.cafe.bot</a> &gt; <span class="el_source">AudioCommands.java</span></div><h1>AudioCommands.java</h1><pre class="source lang-java linenums">package dev.cafe.bot;

import dev.cafe.audio.AudioTrack;
import dev.cafe.audio.SearchResult;
import dev.cafe.core.AudioController;
import dev.cafe.core.Playlist;
import dev.cafe.core.PlaylistManager;
import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import net.dv8tion.jda.api.EmbedBuilder;
import net.dv8tion.jda.api.entities.Member;
import net.dv8tion.jda.api.entities.channel.middleman.AudioChannel;
import net.dv8tion.jda.api.events.interaction.command.SlashCommandInteractionEvent;
import net.dv8tion.jda.api.events.interaction.component.ButtonInteractionEvent;
import net.dv8tion.jda.api.events.session.ReadyEvent;
import net.dv8tion.jda.api.hooks.ListenerAdapter;
import net.dv8tion.jda.api.interactions.commands.OptionType;
import net.dv8tion.jda.api.interactions.commands.build.Commands;
import net.dv8tion.jda.api.interactions.commands.build.SubcommandData;
import net.dv8tion.jda.api.interactions.components.ActionRow;
import net.dv8tion.jda.api.interactions.components.buttons.Button;
import net.dv8tion.jda.api.managers.AudioManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/** Audio slash commands for music playback. */
public class AudioCommands extends ListenerAdapter {
<span class="nc" id="L31">  private static final Logger logger = LoggerFactory.getLogger(AudioCommands.class);</span>

  private final AudioController audioController;
  private final PlaylistManager playlistManager;
<span class="nc" id="L35">  private final ConcurrentMap&lt;String, List&lt;AudioTrack&gt;&gt; searchCache = new ConcurrentHashMap&lt;&gt;();</span>

<span class="nc" id="L37">  public AudioCommands(AudioController audioController, PlaylistManager playlistManager) {</span>
<span class="nc" id="L38">    this.audioController = audioController;</span>
<span class="nc" id="L39">    this.playlistManager = playlistManager;</span>
<span class="nc" id="L40">  }</span>

  @Override
  public void onReady(ReadyEvent event) {
<span class="nc" id="L44">    event</span>
<span class="nc" id="L45">        .getJDA()</span>
<span class="nc" id="L46">        .updateCommands()</span>
<span class="nc" id="L47">        .addCommands(</span>
<span class="nc" id="L48">            Commands.slash(&quot;leave&quot;, &quot;Leave the voice channel&quot;),</span>
<span class="nc" id="L49">            Commands.slash(&quot;play&quot;, &quot;Play audio&quot;)</span>
<span class="nc" id="L50">                .addSubcommands(</span>
                    new SubcommandData(&quot;url&quot;, &quot;Play a single song from a URL&quot;)
<span class="nc" id="L52">                        .addOption(OptionType.STRING, &quot;url&quot;, &quot;The URL of the song&quot;, true),</span>
                    new SubcommandData(&quot;playlist&quot;, &quot;Play a playlist from a URL&quot;)
<span class="nc" id="L54">                        .addOption(OptionType.STRING, &quot;url&quot;, &quot;The URL of the playlist&quot;, true),</span>
                    new SubcommandData(&quot;search&quot;, &quot;Search for a song and pick from the results&quot;)
<span class="nc" id="L56">                        .addOption(OptionType.STRING, &quot;query&quot;, &quot;The search query&quot;, true)),</span>
<span class="nc" id="L57">            Commands.slash(&quot;p&quot;, &quot;Play a song, playlist, or search for a song&quot;)</span>
<span class="nc" id="L58">                .addOption(OptionType.STRING, &quot;query&quot;, &quot;URL or search term&quot;, true, false),</span>
<span class="nc" id="L59">            Commands.slash(&quot;playlist&quot;, &quot;Manage playlists&quot;)</span>
<span class="nc" id="L60">                .addOption(OptionType.STRING, &quot;action&quot;, &quot;Action to perform&quot;, true)</span>
<span class="nc" id="L61">                .addOption(OptionType.STRING, &quot;name&quot;, &quot;Playlist name&quot;, false)</span>
<span class="nc" id="L62">                .addOption(OptionType.STRING, &quot;id&quot;, &quot;Playlist ID&quot;, false),</span>
<span class="nc" id="L63">            Commands.slash(&quot;skip&quot;, &quot;Skip the current song&quot;),</span>
<span class="nc" id="L64">            Commands.slash(&quot;stop&quot;, &quot;Stop playback and clear queue&quot;),</span>
<span class="nc" id="L65">            Commands.slash(&quot;queue&quot;, &quot;Show the current queue&quot;),</span>
<span class="nc" id="L66">            Commands.slash(&quot;ping&quot;, &quot;Check if the bot is responsive&quot;))</span>
<span class="nc" id="L67">        .queue();</span>
<span class="nc" id="L68">    logger.info(&quot;Audio commands registered&quot;);</span>
<span class="nc" id="L69">  }</span>

  @Override
  public void onSlashCommandInteraction(SlashCommandInteractionEvent event) {
<span class="nc bnc" id="L73" title="All 2 branches missed.">    if (event.getGuild() == null) {</span>
<span class="nc" id="L74">      event.reply(&quot;This command can only be used in servers!&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L75">      return;</span>
    }

<span class="nc" id="L78">    long guildId = event.getGuild().getIdLong();</span>

<span class="nc bnc" id="L80" title="All 9 branches missed.">    switch (event.getName()) {</span>
      case &quot;leave&quot;:
<span class="nc" id="L82">        handleLeave(event, guildId);</span>
<span class="nc" id="L83">        break;</span>
      case &quot;p&quot;:
<span class="nc" id="L85">        handleP(event, guildId);</span>
<span class="nc" id="L86">        break;</span>
      case &quot;play&quot;:
<span class="nc" id="L88">        handlePlay(event, guildId);</span>
<span class="nc" id="L89">        break;</span>
      case &quot;playlist&quot;:
<span class="nc" id="L91">        handlePlaylist(event, guildId);</span>
<span class="nc" id="L92">        break;</span>
      case &quot;skip&quot;:
<span class="nc" id="L94">        handleSkip(event, guildId);</span>
<span class="nc" id="L95">        break;</span>
      case &quot;stop&quot;:
<span class="nc" id="L97">        handleStop(event, guildId);</span>
<span class="nc" id="L98">        break;</span>
      case &quot;queue&quot;:
<span class="nc" id="L100">        handleQueue(event, guildId);</span>
<span class="nc" id="L101">        break;</span>
      case &quot;ping&quot;:
<span class="nc" id="L103">        handlePing(event);</span>
        break;
    }
<span class="nc" id="L106">  }</span>

  private void handleP(SlashCommandInteractionEvent event, long guildId) {
<span class="nc" id="L109">    String query = event.getOption(&quot;query&quot;).getAsString();</span>

    // Simple URL check. This can be improved, but for now, it's a good heuristic.
<span class="nc bnc" id="L112" title="All 4 branches missed.">    boolean isUrl = query.startsWith(&quot;http://&quot;) || query.startsWith(&quot;https://&quot;);</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">    if (isUrl) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">      if (!ensureVoiceConnection(event)) {</span>
<span class="nc" id="L116">        event.reply(&quot;You need to be in a voice channel to play music!&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L117">        return;</span>
      }
    }

<span class="nc" id="L121">    event.deferReply(true).queue();</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">    if (isUrl) {</span>
      // Direct play (handles song or playlist URLs)
<span class="nc" id="L125">      audioController</span>
<span class="nc" id="L126">          .play(guildId, query)</span>
<span class="nc" id="L127">          .thenAccept(result -&gt; event.getHook().editOriginal(result).queue())</span>
<span class="nc" id="L128">          .exceptionally(</span>
              throwable -&gt; {
<span class="nc" id="L130">                logger.error(&quot;Error playing track&quot;, throwable);</span>
<span class="nc" id="L131">                event</span>
<span class="nc" id="L132">                    .getHook()</span>
<span class="nc" id="L133">                    .editOriginal(&quot;Error playing track: &quot; + throwable.getMessage())</span>
<span class="nc" id="L134">                    .queue();</span>
<span class="nc" id="L135">                return null;</span>
              });
    } else {
      // Search
<span class="nc" id="L139">      audioController</span>
<span class="nc" id="L140">          .searchOnly(query)</span>
<span class="nc" id="L141">          .thenAccept(result -&gt; showSearchResults(event, result, guildId))</span>
<span class="nc" id="L142">          .exceptionally(</span>
              throwable -&gt; {
<span class="nc" id="L144">                logger.error(&quot;Error searching tracks&quot;, throwable);</span>
<span class="nc" id="L145">                event.getHook().editOriginal(&quot;Error searching: &quot; + throwable.getMessage()).queue();</span>
<span class="nc" id="L146">                return null;</span>
              });
    }
<span class="nc" id="L149">  }</span>

  private void handlePlay(SlashCommandInteractionEvent event, long guildId) {
<span class="nc" id="L152">    String subcommand = event.getSubcommandName();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">    if (subcommand == null) {</span>
<span class="nc" id="L154">      event.reply(&quot;Invalid command structure.&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L155">      return;</span>
    }

    // Auto-join user's voice channel if not connected
<span class="nc bnc" id="L159" title="All 4 branches missed.">    if (!subcommand.equals(&quot;search&quot;) &amp;&amp; !ensureVoiceConnection(event)) {</span>
<span class="nc" id="L160">      event.reply(&quot;You need to be in a voice channel!&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L161">      return;</span>
    }

<span class="nc" id="L164">    event.deferReply(true).queue();</span>

<span class="nc bnc" id="L166" title="All 3 branches missed.">    switch (subcommand) {</span>
      case &quot;url&quot;:
      case &quot;playlist&quot;:
<span class="nc" id="L169">        String url = event.getOption(&quot;url&quot;).getAsString();</span>
        // Direct play
<span class="nc" id="L171">        audioController</span>
<span class="nc" id="L172">            .play(guildId, url)</span>
<span class="nc" id="L173">            .thenAccept(result -&gt; event.getHook().editOriginal(result).queue())</span>
<span class="nc" id="L174">            .exceptionally(</span>
                throwable -&gt; {
<span class="nc" id="L176">                  logger.error(&quot;Error playing track&quot;, throwable);</span>
<span class="nc" id="L177">                  event</span>
<span class="nc" id="L178">                      .getHook()</span>
<span class="nc" id="L179">                      .editOriginal(&quot;Error playing track: &quot; + throwable.getMessage())</span>
<span class="nc" id="L180">                      .queue();</span>
<span class="nc" id="L181">                  return null;</span>
                });
<span class="nc" id="L183">        break;</span>

      case &quot;search&quot;:
<span class="nc" id="L186">        String query = event.getOption(&quot;query&quot;).getAsString();</span>
<span class="nc" id="L187">        audioController</span>
<span class="nc" id="L188">            .searchOnly(query)</span>
<span class="nc" id="L189">            .thenAccept(result -&gt; showSearchResults(event, result, guildId))</span>
<span class="nc" id="L190">            .exceptionally(</span>
                throwable -&gt; {
<span class="nc" id="L192">                  logger.error(&quot;Error searching tracks&quot;, throwable);</span>
<span class="nc" id="L193">                  event</span>
<span class="nc" id="L194">                      .getHook()</span>
<span class="nc" id="L195">                      .editOriginal(&quot;Error searching: &quot; + throwable.getMessage())</span>
<span class="nc" id="L196">                      .queue();</span>
<span class="nc" id="L197">                  return null;</span>
                });
        break;
    }
<span class="nc" id="L201">  }</span>

  private void handlePlaylist(SlashCommandInteractionEvent event, long guildId) {
<span class="nc" id="L204">    String action = event.getOption(&quot;action&quot;).getAsString();</span>
<span class="nc" id="L205">    long userId = event.getUser().getIdLong();</span>

<span class="nc bnc" id="L207" title="All 5 branches missed.">    switch (action.toLowerCase()) {</span>
      case &quot;create&quot;:
        String name =
<span class="nc bnc" id="L210" title="All 2 branches missed.">            event.getOption(&quot;name&quot;) != null ? event.getOption(&quot;name&quot;).getAsString() : null;</span>
<span class="nc bnc" id="L211" title="All 4 branches missed.">        if (name == null || name.trim().isEmpty()) {</span>
<span class="nc" id="L212">          event.reply(&quot;Please provide a playlist name!&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L213">          return;</span>
        }

<span class="nc" id="L216">        Playlist playlist = playlistManager.createPlaylist(userId, name.trim());</span>
<span class="nc" id="L217">        event</span>
<span class="nc" id="L218">            .reply(</span>
<span class="nc" id="L219">                String.format(</span>
<span class="nc" id="L220">                    &quot;Created playlist '%s' with ID: `%s`&quot;, playlist.getName(), playlist.getId()))</span>
<span class="nc" id="L221">            .setEphemeral(true)</span>
<span class="nc" id="L222">            .queue();</span>
<span class="nc" id="L223">        break;</span>

      case &quot;list&quot;:
<span class="nc" id="L226">        List&lt;Playlist&gt; userPlaylists = playlistManager.getUserPlaylists(userId);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (userPlaylists.isEmpty()) {</span>
<span class="nc" id="L228">          event</span>
<span class="nc" id="L229">              .reply(</span>
                  &quot;You don't have any playlists. Use `/playlist action:create name:My Playlist` to create one!&quot;)
<span class="nc" id="L231">              .setEphemeral(true)</span>
<span class="nc" id="L232">              .queue();</span>
<span class="nc" id="L233">          return;</span>
        }

<span class="nc" id="L236">        EmbedBuilder embed = new EmbedBuilder().setTitle(&quot;üéµ Your Playlists&quot;).setColor(0x1DB954);</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">        for (Playlist pl : userPlaylists) {</span>
<span class="nc" id="L239">          embed.addField(</span>
<span class="nc" id="L240">              pl.getName(),</span>
<span class="nc" id="L241">              String.format(</span>
                  &quot;**%d tracks** ‚Ä¢ ID: `%s`\nCreated: &lt;t:%d:R&gt;&quot;,
<span class="nc" id="L243">                  pl.size(), pl.getId(), pl.getCreatedAt().getEpochSecond()),</span>
              false);
<span class="nc" id="L245">        }</span>

<span class="nc" id="L247">        event.replyEmbeds(embed.build()).setEphemeral(true).queue();</span>
<span class="nc" id="L248">        break;</span>

      case &quot;load&quot;:
        // Auto-join user's voice channel if not connected
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!ensureVoiceConnection(event)) {</span>
<span class="nc" id="L253">          event</span>
<span class="nc" id="L254">              .reply(&quot;You need to be in a voice channel to load a playlist!&quot;)</span>
<span class="nc" id="L255">              .setEphemeral(true)</span>
<span class="nc" id="L256">              .queue();</span>
<span class="nc" id="L257">          return;</span>
        }

        String playlistId =
<span class="nc bnc" id="L261" title="All 2 branches missed.">            event.getOption(&quot;id&quot;) != null ? event.getOption(&quot;id&quot;).getAsString() : null;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (playlistId == null) {</span>
<span class="nc" id="L263">          event.reply(&quot;Please provide a playlist ID!&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L264">          return;</span>
        }

<span class="nc" id="L267">        String result = playlistManager.loadPlaylistToQueue(playlistId, audioController, guildId);</span>
<span class="nc" id="L268">        event.reply(result).setEphemeral(true).queue();</span>
<span class="nc" id="L269">        break;</span>

      case &quot;show&quot;:
<span class="nc bnc" id="L272" title="All 2 branches missed.">        String showId = event.getOption(&quot;id&quot;) != null ? event.getOption(&quot;id&quot;).getAsString() : null;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (showId == null) {</span>
<span class="nc" id="L274">          event.reply(&quot;Please provide a playlist ID!&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L275">          return;</span>
        }

<span class="nc" id="L278">        playlistManager</span>
<span class="nc" id="L279">            .getPlaylist(showId)</span>
<span class="nc" id="L280">            .ifPresentOrElse(</span>
                pl -&gt; {
<span class="nc" id="L282">                  EmbedBuilder playlistEmbed =</span>
                      new EmbedBuilder()
<span class="nc" id="L284">                          .setTitle(&quot;üéµ &quot; + pl.getName())</span>
<span class="nc" id="L285">                          .setDescription(</span>
<span class="nc" id="L286">                              String.format(</span>
<span class="nc" id="L287">                                  &quot;**%d tracks** ‚Ä¢ Created by &lt;@%d&gt;&quot;, pl.size(), pl.getOwnerId()))</span>
<span class="nc" id="L288">                          .setColor(0x1DB954);</span>

<span class="nc" id="L290">                  List&lt;AudioTrack&gt; tracks = pl.getTracks();</span>
<span class="nc" id="L291">                  int maxShow = Math.min(10, tracks.size());</span>
<span class="nc" id="L292">                  StringBuilder trackList = new StringBuilder();</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">                  for (int i = 0; i &lt; maxShow; i++) {</span>
<span class="nc" id="L295">                    AudioTrack track = tracks.get(i);</span>
<span class="nc" id="L296">                    trackList.append(</span>
<span class="nc" id="L297">                        String.format(</span>
<span class="nc" id="L298">                            &quot;%d. **%s** - %s\n&quot;, i + 1, track.getTitle(), track.getAuthor()));</span>
                  }

<span class="nc bnc" id="L301" title="All 2 branches missed.">                  if (tracks.size() &gt; maxShow) {</span>
<span class="nc" id="L302">                    trackList.append(</span>
<span class="nc" id="L303">                        String.format(&quot;... and %d more tracks&quot;, tracks.size() - maxShow));</span>
                  }

<span class="nc bnc" id="L306" title="All 2 branches missed.">                  if (!trackList.toString().isEmpty()) {</span>
<span class="nc" id="L307">                    playlistEmbed.addField(&quot;Tracks&quot;, trackList.toString(), false);</span>
                  }

<span class="nc" id="L310">                  event.replyEmbeds(playlistEmbed.build()).setEphemeral(true).queue();</span>
<span class="nc" id="L311">                },</span>
                () -&gt; {
<span class="nc" id="L313">                  event.reply(&quot;Playlist not found!&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L314">                });</span>
<span class="nc" id="L315">        break;</span>

      default:
<span class="nc" id="L318">        event</span>
<span class="nc" id="L319">            .reply(</span>
                &quot;Available actions: `create`, `list`, `load`, `show`\n&quot;
                    + &quot;Examples:\n&quot;
                    + &quot;‚Ä¢ `/playlist action:create name:My Playlist`\n&quot;
                    + &quot;‚Ä¢ `/playlist action:list`\n&quot;
                    + &quot;‚Ä¢ `/playlist action:load id:playlist-id`\n&quot;
                    + &quot;‚Ä¢ `/playlist action:show id:playlist-id`&quot;)
<span class="nc" id="L326">            .setEphemeral(true)</span>
<span class="nc" id="L327">            .queue();</span>
    }
<span class="nc" id="L329">  }</span>

  private void handleSkip(SlashCommandInteractionEvent event, long guildId) {
<span class="nc" id="L332">    String result = audioController.skip(guildId);</span>
<span class="nc" id="L333">    event.reply(result).setEphemeral(true).queue();</span>
<span class="nc" id="L334">  }</span>

  private void handleStop(SlashCommandInteractionEvent event, long guildId) {
<span class="nc" id="L337">    String result = audioController.stop(guildId);</span>
<span class="nc" id="L338">    event.reply(result).setEphemeral(true).queue();</span>
<span class="nc" id="L339">  }</span>

  private void handleQueue(SlashCommandInteractionEvent event, long guildId) {
<span class="nc" id="L342">    String result = audioController.getQueueInfo(guildId);</span>
<span class="nc" id="L343">    event.reply(result).setEphemeral(true).queue();</span>
<span class="nc" id="L344">  }</span>

  private void handleLeave(SlashCommandInteractionEvent event, long guildId) {
<span class="nc" id="L347">    AudioManager audioManager = event.getGuild().getAudioManager();</span>

<span class="nc bnc" id="L349" title="All 2 branches missed.">    if (!audioManager.isConnected()) {</span>
<span class="nc" id="L350">      event.reply(&quot;I'm not connected to a voice channel!&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L351">      return;</span>
    }

<span class="nc" id="L354">    audioManager.closeAudioConnection();</span>
<span class="nc" id="L355">    event.reply(&quot;Left the voice channel&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L356">  }</span>

  private void handlePing(SlashCommandInteractionEvent event) {
<span class="nc" id="L359">    long gatewayPing = event.getJDA().getGatewayPing();</span>
<span class="nc" id="L360">    event.reply(&quot;Pong! Gateway ping: &quot; + gatewayPing + &quot;ms&quot;).setEphemeral(true).queue();</span>
<span class="nc" id="L361">  }</span>

  @Override
  public void onButtonInteraction(ButtonInteractionEvent event) {
<span class="nc" id="L365">    String buttonId = event.getComponentId();</span>

<span class="nc bnc" id="L367" title="All 2 branches missed.">    if (buttonId.startsWith(&quot;track_&quot;)) {</span>
<span class="nc" id="L368">      String[] parts = buttonId.split(&quot;_&quot;);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">      if (parts.length &gt;= 3) {</span>
        // Auto-join user's voice channel if not connected
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (!ensureVoiceConnection(event)) {</span>
<span class="nc" id="L372">          event</span>
<span class="nc" id="L373">              .reply(&quot;You need to be in a voice channel to play music!&quot;)</span>
<span class="nc" id="L374">              .setEphemeral(true)</span>
<span class="nc" id="L375">              .queue();</span>
<span class="nc" id="L376">          return;</span>
        }

<span class="nc" id="L379">        String searchId = parts[1];</span>
<span class="nc" id="L380">        int trackIndex = Integer.parseInt(parts[2]);</span>

<span class="nc" id="L382">        List&lt;AudioTrack&gt; tracks = searchCache.get(searchId);</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">        if (tracks != null &amp;&amp; trackIndex &lt; tracks.size()) {</span>
<span class="nc" id="L384">          AudioTrack selectedTrack = tracks.get(trackIndex);</span>
<span class="nc" id="L385">          long guildId = event.getGuild().getIdLong();</span>

<span class="nc" id="L387">          String result = audioController.playSelectedTrack(guildId, selectedTrack);</span>
<span class="nc" id="L388">          event.reply(result).setEphemeral(true).queue();</span>

          // Disable the buttons after selection
<span class="nc" id="L391">          event.editComponents().queue();</span>
<span class="nc" id="L392">        } else {</span>
<span class="nc" id="L393">          event.reply(&quot;Search results expired. Please search again.&quot;).setEphemeral(true).queue();</span>
        }
      }
<span class="nc bnc" id="L396" title="All 2 branches missed.">    } else if (buttonId.startsWith(&quot;playlist_&quot;)) {</span>
<span class="nc" id="L397">      String[] parts = buttonId.split(&quot;_&quot;);</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">      if (parts.length &gt;= 3) {</span>
<span class="nc" id="L399">        String searchId = parts[1];</span>
<span class="nc" id="L400">        int trackIndex = Integer.parseInt(parts[2]);</span>

<span class="nc" id="L402">        List&lt;AudioTrack&gt; tracks = searchCache.get(searchId);</span>
<span class="nc bnc" id="L403" title="All 4 branches missed.">        if (tracks != null &amp;&amp; trackIndex &lt; tracks.size()) {</span>
<span class="nc" id="L404">          AudioTrack selectedTrack = tracks.get(trackIndex);</span>
<span class="nc" id="L405">          showPlaylistSelection(event, selectedTrack);</span>
<span class="nc" id="L406">        } else {</span>
<span class="nc" id="L407">          event.reply(&quot;Search results expired. Please search again.&quot;).setEphemeral(true).queue();</span>
        }
      }
<span class="nc bnc" id="L410" title="All 2 branches missed.">    } else if (buttonId.startsWith(&quot;addtopl_&quot;)) {</span>
<span class="nc" id="L411">      String[] parts = buttonId.split(&quot;_&quot;, 3);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">      if (parts.length &gt;= 3) {</span>
<span class="nc" id="L413">        String playlistId = parts[1];</span>
<span class="nc" id="L414">        String trackData = parts[2]; // This would need to be encoded track info</span>

        // For simplicity, we'll handle this differently - store track in cache
<span class="nc" id="L417">        event</span>
<span class="nc" id="L418">            .reply(&quot;Track would be added to playlist (feature needs track persistence)&quot;)</span>
<span class="nc" id="L419">            .setEphemeral(true)</span>
<span class="nc" id="L420">            .queue();</span>
      }
    }
<span class="nc" id="L423">  }</span>

  private void showSearchResults(
      SlashCommandInteractionEvent event, SearchResult result, long guildId) {
<span class="nc bnc" id="L427" title="All 4 branches missed.">    if (result.getType() != SearchResult.Type.SEARCH_RESULT || result.getTracks().isEmpty()) {</span>
<span class="nc" id="L428">      event.getHook().editOriginal(&quot;No search results found.&quot;).queue();</span>
<span class="nc" id="L429">      return;</span>
    }

<span class="nc" id="L432">    List&lt;AudioTrack&gt; tracks = result.getTracks();</span>
<span class="nc" id="L433">    int maxResults = Math.min(5, tracks.size()); // Show max 5 results</span>
<span class="nc" id="L434">    String searchId = String.valueOf(System.currentTimeMillis());</span>

    // Cache the search results
<span class="nc" id="L437">    searchCache.put(searchId, tracks.subList(0, maxResults));</span>

<span class="nc" id="L439">    EmbedBuilder embed =</span>
        new EmbedBuilder()
<span class="nc" id="L441">            .setTitle(&quot;üîç Search Results&quot;)</span>
<span class="nc" id="L442">            .setDescription(&quot;Select a track to play:&quot;)</span>
<span class="nc" id="L443">            .setColor(0x1DB954);</span>

<span class="nc" id="L445">    List&lt;Button&gt; buttons = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L447" title="All 2 branches missed.">    for (int i = 0; i &lt; maxResults; i++) {</span>
<span class="nc" id="L448">      AudioTrack track = tracks.get(i);</span>
<span class="nc" id="L449">      String duration = formatDuration(track.getDuration());</span>

<span class="nc" id="L451">      embed.addField(</span>
<span class="nc" id="L452">          String.format(&quot;%d. %s&quot;, i + 1, track.getTitle()),</span>
<span class="nc" id="L453">          String.format(&quot;**%s** ‚Ä¢ %s&quot;, track.getAuthor(), duration),</span>
          false);

<span class="nc" id="L456">      buttons.add(Button.primary(String.format(&quot;track_%s_%d&quot;, searchId, i), String.valueOf(i + 1)));</span>

      // Add playlist button for every 2nd track to avoid too many buttons
<span class="nc bnc" id="L459" title="All 4 branches missed.">      if (i % 2 == 1 &amp;&amp; i &lt; 4) {</span>
<span class="nc" id="L460">        buttons.add(Button.secondary(String.format(&quot;playlist_%s_%d&quot;, searchId, i - 1), &quot;‚ûï&quot;));</span>
      }
    }

    // Remove cached results after 5 minutes
<span class="nc" id="L465">    event</span>
<span class="nc" id="L466">        .getJDA()</span>
<span class="nc" id="L467">        .getRestPing()</span>
<span class="nc" id="L468">        .queue(</span>
            ping -&gt; {
<span class="nc" id="L470">              event</span>
<span class="nc" id="L471">                  .getJDA()</span>
<span class="nc" id="L472">                  .getRateLimitPool()</span>
<span class="nc" id="L473">                  .schedule(</span>
                      () -&gt; {
<span class="nc" id="L475">                        searchCache.remove(searchId);</span>
<span class="nc" id="L476">                      },</span>
                      5,
                      java.util.concurrent.TimeUnit.MINUTES);
<span class="nc" id="L479">            });</span>

<span class="nc" id="L481">    event.getHook().editOriginalEmbeds(embed.build()).setComponents(ActionRow.of(buttons)).queue();</span>
<span class="nc" id="L482">  }</span>

  private String formatDuration(Duration duration) {
<span class="nc bnc" id="L485" title="All 2 branches missed.">    if (duration == null) return &quot;Unknown&quot;;</span>

<span class="nc" id="L487">    long seconds = duration.getSeconds();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">    if (seconds &lt; 0) return &quot;Stream&quot;;</span>

<span class="nc" id="L490">    long hours = seconds / 3600;</span>
<span class="nc" id="L491">    long minutes = (seconds % 3600) / 60;</span>
<span class="nc" id="L492">    long secs = seconds % 60;</span>

<span class="nc bnc" id="L494" title="All 2 branches missed.">    if (hours &gt; 0) {</span>
<span class="nc" id="L495">      return String.format(&quot;%d:%02d:%02d&quot;, hours, minutes, secs);</span>
    } else {
<span class="nc" id="L497">      return String.format(&quot;%d:%02d&quot;, minutes, secs);</span>
    }
  }

  private void showPlaylistSelection(ButtonInteractionEvent event, AudioTrack track) {
<span class="nc" id="L502">    long userId = event.getUser().getIdLong();</span>
<span class="nc" id="L503">    List&lt;Playlist&gt; userPlaylists = playlistManager.getUserPlaylists(userId);</span>

<span class="nc bnc" id="L505" title="All 2 branches missed.">    if (userPlaylists.isEmpty()) {</span>
<span class="nc" id="L506">      event</span>
<span class="nc" id="L507">          .reply(</span>
              &quot;You don't have any playlists! Create one with `/playlist action:create name:My Playlist`&quot;)
<span class="nc" id="L509">          .setEphemeral(true)</span>
<span class="nc" id="L510">          .queue();</span>
<span class="nc" id="L511">      return;</span>
    }

<span class="nc" id="L514">    EmbedBuilder embed =</span>
        new EmbedBuilder()
<span class="nc" id="L516">            .setTitle(&quot;‚ûï Add to Playlist&quot;)</span>
<span class="nc" id="L517">            .setDescription(</span>
<span class="nc" id="L518">                String.format(</span>
<span class="nc" id="L519">                    &quot;Select a playlist to add **%s** by %s&quot;, track.getTitle(), track.getAuthor()))</span>
<span class="nc" id="L520">            .setColor(0x1DB954);</span>

<span class="nc" id="L522">    List&lt;Button&gt; buttons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">    for (int i = 0; i &lt; Math.min(5, userPlaylists.size()); i++) {</span>
<span class="nc" id="L524">      Playlist playlist = userPlaylists.get(i);</span>
<span class="nc" id="L525">      buttons.add(</span>
<span class="nc" id="L526">          Button.success(</span>
<span class="nc" id="L527">              String.format(&quot;addtrack_%s_%s&quot;, playlist.getId(), System.currentTimeMillis()),</span>
<span class="nc" id="L528">              String.format(&quot;%s (%d)&quot;, playlist.getName(), playlist.size())));</span>

      // Store track temporarily for adding to playlist
<span class="nc" id="L531">      searchCache.put(&quot;track_&quot; + System.currentTimeMillis(), List.of(track));</span>
    }

<span class="nc" id="L534">    event</span>
<span class="nc" id="L535">        .replyEmbeds(embed.build())</span>
<span class="nc" id="L536">        .setComponents(ActionRow.of(buttons))</span>
<span class="nc" id="L537">        .setEphemeral(true)</span>
<span class="nc" id="L538">        .queue();</span>
<span class="nc" id="L539">  }</span>

  /**
   * Automatically join user's voice channel if bot is not connected.
   *
   * @param event The command event
   * @return true if connected or successfully joined, false if user not in voice channel
   */
  private boolean ensureVoiceConnection(SlashCommandInteractionEvent event) {
<span class="nc" id="L548">    AudioManager audioManager = event.getGuild().getAudioManager();</span>

    // Already connected
<span class="nc bnc" id="L551" title="All 2 branches missed.">    if (audioManager.isConnected()) {</span>
<span class="nc" id="L552">      return true;</span>
    }

    // Check if user is in voice channel
<span class="nc" id="L556">    Member member = event.getMember();</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">    if (member == null</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">        || member.getVoiceState() == null</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">        || !member.getVoiceState().inAudioChannel()) {</span>
<span class="nc" id="L560">      return false;</span>
    }

    // Join user's voice channel
<span class="nc" id="L564">    AudioChannel voiceChannel = member.getVoiceState().getChannel();</span>
<span class="nc" id="L565">    audioManager.openAudioConnection(voiceChannel);</span>
<span class="nc" id="L566">    logger.info(</span>
        &quot;Auto-joined voice channel: {} in guild: {}&quot;,
<span class="nc" id="L568">        voiceChannel.getName(),</span>
<span class="nc" id="L569">        event.getGuild().getName());</span>
<span class="nc" id="L570">    return true;</span>
  }

  /**
   * Automatically join user's voice channel if bot is not connected (for button interactions).
   *
   * @param event The button interaction event
   * @return true if connected or successfully joined, false if user not in voice channel
   */
  private boolean ensureVoiceConnection(ButtonInteractionEvent event) {
<span class="nc" id="L580">    AudioManager audioManager = event.getGuild().getAudioManager();</span>

    // Already connected
<span class="nc bnc" id="L583" title="All 2 branches missed.">    if (audioManager.isConnected()) {</span>
<span class="nc" id="L584">      return true;</span>
    }

    // Check if user is in voice channel
<span class="nc" id="L588">    Member member = event.getMember();</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">    if (member == null</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">        || member.getVoiceState() == null</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">        || !member.getVoiceState().inAudioChannel()) {</span>
<span class="nc" id="L592">      return false;</span>
    }

    // Join user's voice channel
<span class="nc" id="L596">    AudioChannel voiceChannel = member.getVoiceState().getChannel();</span>
<span class="nc" id="L597">    audioManager.openAudioConnection(voiceChannel);</span>
<span class="nc" id="L598">    logger.info(</span>
        &quot;Auto-joined voice channel: {} in guild: {}&quot;,
<span class="nc" id="L600">        voiceChannel.getName(),</span>
<span class="nc" id="L601">        event.getGuild().getName());</span>
<span class="nc" id="L602">    return true;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>