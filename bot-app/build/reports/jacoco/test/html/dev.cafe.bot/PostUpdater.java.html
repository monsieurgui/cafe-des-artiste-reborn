<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostUpdater.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bot-app</a> &gt; <a href="index.source.html" class="el_package">dev.cafe.bot</a> &gt; <span class="el_source">PostUpdater.java</span></div><h1>PostUpdater.java</h1><pre class="source lang-java linenums">package dev.cafe.bot;

import dev.cafe.audio.AudioTrack;
import dev.cafe.audio.PlaybackStrategy;
import dev.cafe.cache.dagger.Streaming;
import dev.cafe.cache.guild.GuildSettingsRepository;
import dev.cafe.core.QueueChangeListener;
import dev.cafe.core.TrackQueue;
import java.awt.Color;
import java.util.List;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import javax.inject.Inject;
import javax.inject.Singleton;
import net.dv8tion.jda.api.EmbedBuilder;
import net.dv8tion.jda.api.JDA;
import net.dv8tion.jda.api.entities.Guild;
import net.dv8tion.jda.api.entities.MessageEmbed;
import net.dv8tion.jda.api.entities.channel.concrete.TextChannel;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/** Updates the queue and now-playing messages. */
@Singleton
public class PostUpdater implements QueueChangeListener {

<span class="nc" id="L28">  private static final Logger LOGGER = LoggerFactory.getLogger(PostUpdater.class);</span>
  private final GuildSettingsRepository guildSettingsRepository;
  private final PlaybackStrategy playbackStrategy;
<span class="nc" id="L31">  private final ScheduledExecutorService nowPlayingExecutor =</span>
<span class="nc" id="L32">      Executors.newSingleThreadScheduledExecutor();</span>
  private JDA jda;

  @Inject
  public PostUpdater(
      GuildSettingsRepository guildSettingsRepository,
<span class="nc" id="L38">      @Streaming PlaybackStrategy playbackStrategy) {</span>
<span class="nc" id="L39">    this.guildSettingsRepository = guildSettingsRepository;</span>
<span class="nc" id="L40">    this.playbackStrategy = playbackStrategy;</span>
<span class="nc" id="L41">  }</span>

  public void setJda(JDA jda) {
<span class="nc" id="L44">    this.jda = jda;</span>
<span class="nc" id="L45">  }</span>

  public void startNowPlayingUpdater() {
<span class="nc" id="L48">    nowPlayingExecutor.scheduleAtFixedRate(</span>
        this::updateAllNowPlayingMessages, 0, 15, TimeUnit.SECONDS);
<span class="nc" id="L50">  }</span>

  private void updateAllNowPlayingMessages() {
<span class="nc bnc" id="L53" title="All 2 branches missed.">    if (jda == null) return;</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">    for (Guild guild : jda.getGuilds()) {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">      if (playbackStrategy.isPlaying(guild.getIdLong())</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">          &amp;&amp; !playbackStrategy.isPaused(guild.getIdLong())) {</span>
<span class="nc" id="L57">        updateNowPlayingMessage(guild.getIdLong());</span>
      }
<span class="nc" id="L59">    }</span>
<span class="nc" id="L60">  }</span>

  private void updateNowPlayingMessage(long guildId) {
<span class="nc" id="L63">    guildSettingsRepository</span>
<span class="nc" id="L64">        .findById(guildId)</span>
<span class="nc" id="L65">        .ifPresent(</span>
            settings -&gt; {
<span class="nc" id="L67">              AudioTrack currentTrack = playbackStrategy.getCurrentTrack(guildId);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">              if (currentTrack == null) return;</span>

<span class="nc" id="L70">              TextChannel channel = jda.getTextChannelById(settings.channelId());</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">              if (channel == null) return;</span>

<span class="nc" id="L73">              channel</span>
<span class="nc" id="L74">                  .retrieveMessageById(settings.nowPlayingMsgId())</span>
<span class="nc" id="L75">                  .queue(</span>
                      message -&gt;
<span class="nc" id="L77">                          message</span>
<span class="nc" id="L78">                              .editMessageEmbeds(buildNowPlayingEmbed(currentTrack, guildId))</span>
<span class="nc" id="L79">                              .queue(),</span>
                      failure -&gt;
<span class="nc" id="L81">                          LOGGER.warn(&quot;Could not find now-playing message for guild {}&quot;, guildId));</span>
<span class="nc" id="L82">            });</span>
<span class="nc" id="L83">  }</span>

  private MessageEmbed buildNowPlayingEmbed(AudioTrack track, long guildId) {
<span class="nc" id="L86">    long position = playbackStrategy.getPosition(guildId);</span>
<span class="nc" id="L87">    long duration = track.getDuration().toMillis();</span>
<span class="nc" id="L88">    return new EmbedBuilder()</span>
<span class="nc" id="L89">        .setTitle(&quot;‚ñ∂Ô∏è Now Playing&quot;)</span>
<span class="nc" id="L90">        .setDescription(</span>
<span class="nc" id="L91">            String.format(&quot;[%s](%s) by %s&quot;, track.getTitle(), track.getUrl(), track.getAuthor()))</span>
<span class="nc" id="L92">        .addField(&quot;Progress&quot;, buildProgressBar(position, duration), false)</span>
<span class="nc" id="L93">        .setColor(new Color(0x1DB954))</span>
<span class="nc" id="L94">        .build();</span>
  }

  private String buildProgressBar(long position, long duration) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">    if (duration &lt;= 0) return &quot;‚àû&quot;;</span>
<span class="nc" id="L99">    int barLength = 20;</span>
<span class="nc" id="L100">    int progress = (int) ((double) position / duration * barLength);</span>
<span class="nc" id="L101">    StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L102">    sb.append(&quot;`&quot;);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">    for (int i = 0; i &lt; barLength; i++) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">      sb.append(i &lt; progress ? '‚ñà' : '‚ñë');</span>
    }
<span class="nc" id="L106">    sb.append(&quot;` &quot;);</span>
<span class="nc" id="L107">    sb.append(formatDuration(position)).append(&quot; / &quot;).append(formatDuration(duration));</span>
<span class="nc" id="L108">    return sb.toString();</span>
  }

  private String formatDuration(long millis) {
<span class="nc" id="L112">    long seconds = millis / 1000;</span>
<span class="nc" id="L113">    long minutes = seconds / 60;</span>
<span class="nc" id="L114">    long hours = minutes / 60;</span>
<span class="nc" id="L115">    seconds %= 60;</span>
<span class="nc" id="L116">    minutes %= 60;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">    return hours &gt; 0</span>
<span class="nc" id="L118">        ? String.format(&quot;%d:%02d:%02d&quot;, hours, minutes, seconds)</span>
<span class="nc" id="L119">        : String.format(&quot;%02d:%02d&quot;, minutes, seconds);</span>
  }

  @Override
  public void onQueueChanged(long guildId, TrackQueue queue) {
<span class="nc bnc" id="L124" title="All 2 branches missed.">    if (jda == null) {</span>
<span class="nc" id="L125">      LOGGER.warn(&quot;JDA is not yet available for PostUpdater.&quot;);</span>
<span class="nc" id="L126">      return;</span>
    }

<span class="nc" id="L129">    guildSettingsRepository</span>
<span class="nc" id="L130">        .findById(guildId)</span>
<span class="nc" id="L131">        .ifPresent(</span>
            settings -&gt; {
<span class="nc" id="L133">              TextChannel channel = jda.getTextChannelById(settings.channelId());</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">              if (channel == null) {</span>
<span class="nc" id="L135">                LOGGER.warn(</span>
                    &quot;Could not find channel with ID {} for guild {}&quot;,
<span class="nc" id="L137">                    settings.channelId(),</span>
<span class="nc" id="L138">                    guildId);</span>
<span class="nc" id="L139">                return;</span>
              }

<span class="nc" id="L142">              channel</span>
<span class="nc" id="L143">                  .retrieveMessageById(settings.queueMsgId())</span>
<span class="nc" id="L144">                  .queue(</span>
<span class="nc" id="L145">                      message -&gt; message.editMessageEmbeds(buildQueueEmbed(queue)).queue(),</span>
                      failure -&gt;
<span class="nc" id="L147">                          LOGGER.warn(</span>
                              &quot;Could not find queue message with ID {} for guild {}&quot;,
<span class="nc" id="L149">                              settings.queueMsgId(),</span>
<span class="nc" id="L150">                              guildId));</span>
<span class="nc" id="L151">            });</span>
<span class="nc" id="L152">  }</span>

  private MessageEmbed buildQueueEmbed(TrackQueue queue) {
<span class="nc" id="L155">    EmbedBuilder embed = new EmbedBuilder();</span>
<span class="nc" id="L156">    embed.setTitle(&quot;üé∂ Queue&quot;);</span>
<span class="nc" id="L157">    embed.setColor(new Color(0x1DB954));</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">    if (queue.isEmpty()) {</span>
<span class="nc" id="L160">      embed.setDescription(&quot;The queue is empty.&quot;);</span>
    } else {
<span class="nc" id="L162">      StringBuilder description = new StringBuilder();</span>
<span class="nc" id="L163">      queue</span>
<span class="nc" id="L164">          .current()</span>
<span class="nc" id="L165">          .ifPresent(</span>
              current -&gt; {
<span class="nc" id="L167">                description.append(&quot;**Now Playing:**\n&quot;);</span>
<span class="nc" id="L168">                description.append(formatTrack(current)).append(&quot;\n\n&quot;);</span>
<span class="nc" id="L169">              });</span>

<span class="nc" id="L171">      List&lt;AudioTrack&gt; upcoming = queue.getTracks();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">      if (!upcoming.isEmpty()) {</span>
<span class="nc" id="L173">        description.append(&quot;**Up Next:**\n&quot;);</span>
<span class="nc" id="L174">        int limit = Math.min(upcoming.size(), 10);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        for (int i = 0; i &lt; limit; i++) {</span>
<span class="nc" id="L176">          description.append(i + 1).append(&quot;. &quot;).append(formatTrack(upcoming.get(i))).append(&quot;\n&quot;);</span>
        }
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (upcoming.size() &gt; limit) {</span>
<span class="nc" id="L179">          description.append(&quot;...and &quot;).append(upcoming.size() - limit).append(&quot; more.&quot;);</span>
        }
      }
<span class="nc" id="L182">      embed.setDescription(description.toString());</span>
    }
<span class="nc" id="L184">    return embed.build();</span>
  }

  private String formatTrack(AudioTrack track) {
<span class="nc" id="L188">    return String.format(&quot;[%s](%s) by %s&quot;, track.getTitle(), track.getUrl(), track.getAuthor());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>