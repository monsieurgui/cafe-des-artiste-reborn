<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetricsHttpServer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bot-app</a> &gt; <a href="index.source.html" class="el_package">dev.cafe.bot</a> &gt; <span class="el_source">MetricsHttpServer.java</span></div><h1>MetricsHttpServer.java</h1><pre class="source lang-java linenums">package dev.cafe.bot;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpServer;
import dev.cafe.audio.lavalink.LavalinkSearchService;
import dev.cafe.config.ConfigLoader;
import dev.cafe.metrics.MetricsBinder;
import java.io.IOException;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.util.HashMap;
import java.util.Map;
import net.dv8tion.jda.api.JDA;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/** Simple HTTP server for Prometheus metrics endpoint. */
public class MetricsHttpServer {
<span class="nc" id="L21">  private static final Logger logger = LoggerFactory.getLogger(MetricsHttpServer.class);</span>

  private final MetricsBinder metrics;
  private final ConfigLoader config;
  private final ObjectMapper objectMapper;
  private HttpServer server;
  private JDA jda;
  private LavalinkSearchService lavalinkService;

<span class="nc" id="L30">  public MetricsHttpServer(MetricsBinder metrics, ConfigLoader config) {</span>
<span class="nc" id="L31">    this.metrics = metrics;</span>
<span class="nc" id="L32">    this.config = config;</span>
<span class="nc" id="L33">    this.objectMapper = new ObjectMapper();</span>
<span class="nc" id="L34">  }</span>

  public void setJDA(JDA jda) {
<span class="nc" id="L37">    this.jda = jda;</span>
<span class="nc" id="L38">  }</span>

  public void setLavalinkService(LavalinkSearchService lavalinkService) {
<span class="nc" id="L41">    this.lavalinkService = lavalinkService;</span>
<span class="nc" id="L42">  }</span>

  public void start() throws IOException {
<span class="nc" id="L45">    server = HttpServer.create(new InetSocketAddress(8080), 0);</span>
<span class="nc" id="L46">    server.createContext(&quot;/metrics&quot;, new MetricsHandler());</span>
<span class="nc" id="L47">    server.createContext(&quot;/health&quot;, new HealthHandler());</span>
<span class="nc" id="L48">    server.setExecutor(null);</span>
<span class="nc" id="L49">    server.start();</span>
<span class="nc" id="L50">    logger.info(&quot;Metrics server started on port 8080&quot;);</span>
<span class="nc" id="L51">  }</span>

  public void stop() {
<span class="nc bnc" id="L54" title="All 2 branches missed.">    if (server != null) {</span>
<span class="nc" id="L55">      server.stop(0);</span>
<span class="nc" id="L56">      logger.info(&quot;Metrics server stopped&quot;);</span>
    }
<span class="nc" id="L58">  }</span>

<span class="nc" id="L60">  private class MetricsHandler implements HttpHandler {</span>
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="nc" id="L63">      String response = metrics.getMetrics();</span>
<span class="nc" id="L64">      exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/plain; charset=utf-8&quot;);</span>
<span class="nc" id="L65">      exchange.sendResponseHeaders(200, response.getBytes().length);</span>
<span class="nc" id="L66">      try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L67">        os.write(response.getBytes());</span>
      }
<span class="nc" id="L69">    }</span>
  }

<span class="nc" id="L72">  private class HealthHandler implements HttpHandler {</span>
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="nc" id="L75">      Map&lt;String, Object&gt; health = new HashMap&lt;&gt;();</span>

      try {
        // Check bot status
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (jda != null) {</span>
<span class="nc" id="L80">          health.put(</span>
              &quot;bot&quot;,
<span class="nc" id="L82">              Map.of(</span>
<span class="nc" id="L83">                  &quot;status&quot;, jda.getStatus().name(),</span>
<span class="nc" id="L84">                  &quot;ping&quot;, jda.getGatewayPing(),</span>
<span class="nc" id="L85">                  &quot;guilds&quot;, jda.getGuilds().size(),</span>
                  &quot;shards&quot;,
<span class="nc bnc" id="L87" title="All 2 branches missed.">                      jda.getShardInfo() != null</span>
<span class="nc" id="L88">                          ? Map.of(</span>
<span class="nc" id="L89">                              &quot;current&quot;, jda.getShardInfo().getShardId(),</span>
<span class="nc" id="L90">                              &quot;total&quot;, jda.getShardInfo().getShardTotal())</span>
<span class="nc" id="L91">                          : Map.of(&quot;current&quot;, 0, &quot;total&quot;, 1)));</span>
        } else {
<span class="nc" id="L93">          health.put(&quot;bot&quot;, Map.of(&quot;status&quot;, &quot;NOT_READY&quot;));</span>
        }

        // Check Lavalink status if using Lavalink backend
<span class="nc bnc" id="L97" title="All 4 branches missed.">        if (&quot;lavalink&quot;.equals(config.getAudioBackend()) &amp;&amp; lavalinkService != null) {</span>
<span class="nc" id="L98">          health.put(</span>
              &quot;lavalink&quot;,
<span class="nc" id="L100">              Map.of(</span>
<span class="nc" id="L101">                  &quot;host&quot;, config.getLavalinkHost(),</span>
<span class="nc" id="L102">                  &quot;port&quot;, config.getLavalinkPort(),</span>
<span class="nc" id="L103">                  &quot;healthy&quot;, lavalinkService.isHealthy()));</span>
        } else {
<span class="nc" id="L105">          health.put(&quot;audio&quot;, Map.of(&quot;backend&quot;, config.getAudioBackend()));</span>
        }

<span class="nc" id="L108">        health.put(&quot;timestamp&quot;, System.currentTimeMillis());</span>
<span class="nc" id="L109">        health.put(&quot;status&quot;, &quot;UP&quot;);</span>

<span class="nc" id="L111">        String response = objectMapper.writeValueAsString(health);</span>
<span class="nc" id="L112">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L113">        exchange.sendResponseHeaders(200, response.getBytes().length);</span>
<span class="nc" id="L114">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L115">          os.write(response.getBytes());</span>
        }
<span class="nc" id="L117">      } catch (Exception e) {</span>
<span class="nc" id="L118">        logger.error(&quot;Health check failed&quot;, e);</span>
<span class="nc" id="L119">        health.put(&quot;status&quot;, &quot;DOWN&quot;);</span>
<span class="nc" id="L120">        health.put(&quot;error&quot;, e.getMessage());</span>

<span class="nc" id="L122">        String response = objectMapper.writeValueAsString(health);</span>
<span class="nc" id="L123">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L124">        exchange.sendResponseHeaders(500, response.getBytes().length);</span>
<span class="nc" id="L125">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L126">          os.write(response.getBytes());</span>
        }
<span class="nc" id="L128">      }</span>
<span class="nc" id="L129">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>